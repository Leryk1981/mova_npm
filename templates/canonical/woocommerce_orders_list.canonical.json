{
  "mova_version": "3.3",
  "$comment": "WooCommerce: pobrać zamówienia z paginacją i zapisać w NDJSON.",
  "actions": [
    {
      "type": "secrets.get",
      "name": "<CK_SECRET_NAME>",
      "out": "vars.ck"
    },
    {
      "type": "secrets.get",
      "name": "<CS_SECRET_NAME>",
      "out": "vars.cs"
    },
    {
      "type": "ustawić_zmienną",
      "variable": "vars.base",
      "value": "<BASE_URL>"
    },
    {
      "type": "ustawić_zmienną",
      "variable": "vars.page",
      "value": 1
    },
    {
      "type": "powtórzyć",
      "count": 10,
      "actions": [
        {
          "type": "http_request",
          "method": "GET",
          "url": "${vars.base}/wp-json/wc/v3/orders",
          "auth": {
            "type": "basic",
            "username": "${vars.ck}",
            "password": "${vars.cs}"
          },
          "query": {
            "per_page": 100,
            "page": "${vars.page}",
            "status": "<STATUS>",
            "after": "<AFTER_ISO>"
          },
          "out": "vars.page_data"
        },
        {
          "type": "if",
          "expr": "${Array.isArray(vars.page_data) && vars.page_data.length > 0}",
          "then": [
            {
              "type": "for_each",
              "lista": "${vars.page_data}",
              "loop_variable": "order",
              "actions": [
                {
                  "type": "zapisać_plik",
                  "path": "<OUT_FILE>",
                  "value": "${order}",
                  "mode": "append_jsonl"
                }
              ]
            },
            {
              "type": "ustawić_zmienną",
              "variable": "vars.page",
              "value": "${vars.page + 1}"
            }
          ],
          "else": [
            {
              "type": "return",
              "value": "done"
            }
          ]
        }
      ]
    }
  ]
}