{
  "version": "3.3",
  "$comment": "WooCommerce: récupérer les commandes avec pagination et enregistrer en NDJSON.",
  "actions": [
    {
      "type": "récupérer_secret",
      "name": "<CK_SECRET_NAME>",
      "out": "vars.ck"
    },
    {
      "type": "récupérer_secret",
      "name": "<CS_SECRET_NAME>",
      "out": "vars.cs"
    },
    {
      "type": "définir_variable",
      "variable": "vars.base",
      "valeur": "<BASE_URL>"
    },
    {
      "type": "définir_variable",
      "variable": "vars.page",
      "valeur": 1
    },
    {
      "type": "répéter",
      "nombre": 10,
      "actions": [
        {
          "type": "requête_http",
          "méthode": "GET",
          "url": "${vars.base}/wp-json/wc/v3/orders",
          "auth": {
            "type": "basic",
            "username": "${vars.ck}",
            "password": "${vars.cs}"
          },
          "query": {
            "per_page": 100,
            "page": "${vars.page}",
            "status": "<STATUS>",
            "after": "<AFTER_ISO>"
          },
          "out": "vars.page_data"
        },
        {
          "type": "condition",
          "expression": "${Array.isArray(vars.page_data) && vars.page_data.length > 0}",
          "alors": [
            {
              "type": "pour_chaque",
              "liste": "${vars.page_data}",
              "variable_boucle": "order",
              "actions": [
                {
                  "type": "écrire_fichier",
                  "chemin": "<OUT_FILE>",
                  "valeur": "${order}",
                  "mode": "append_jsonl"
                }
              ]
            },
            {
              "type": "définir_variable",
              "variable": "vars.page",
              "valeur": "${vars.page + 1}"
            }
          ],
          "sinon": [
            {
              "type": "retourner",
              "valeur": "done"
            }
          ]
        }
      ]
    }
  ]
}